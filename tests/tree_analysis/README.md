# Tree Analysis Tests

This directory contains tests for the tree analysis module, validating against TraMineR's `seqtree()` and `disstree()` functions.

## Test Dataset

Tests use the **dyadic_children (lsog)** dataset with the first 20 sequences for faster execution.

## Test Files Overview

This directory contains **two complementary test files** with different purposes:

### 1. `test_tree_analysis_lsog.py` - Functional Testing

**Purpose:** Validates that functions work correctly and produce reasonable results.

**Characteristics:**
- ✅ **No external dependencies**: Does not require TraMineR reference files
- ✅ **Fast execution**: Tests basic functionality without heavy computations
- ✅ **Development-friendly**: Can run during development to catch bugs early
- ✅ **CI/CD ready**: Suitable for continuous integration pipelines

**What it tests:**
- Function correctness: Functions execute without errors
- Data structure integrity: Return values have correct structure and types
- Logical consistency: Results satisfy expected mathematical properties
  - Variance is positive
  - Pseudo R² is between 0 and 1
  - Pseudo F is non-negative
  - All sequences are assigned to tree leaves
- Edge cases: Functions handle boundary conditions appropriately
- Weighted vs unweighted behavior consistency

**When to use:**
- During development to ensure functions work correctly
- In CI/CD pipelines for quick validation
- When you want to test functionality without setting up R/TraMineR

### 2. `test_traminer_consistency.py` - Numerical Consistency Verification

**Purpose:** Performs precise numerical comparisons with TraMineR to ensure identical results.

**Characteristics:**
- ⚠️ **Requires TraMineR reference files**: Needs CSV files generated by `traminer_reference.R`
- ✅ **Strict numerical tolerance**: Uses RTOL=1e-6, ATOL=1e-8 for comparisons
- ✅ **Skips gracefully**: If reference files are missing, tests are skipped (not failed)
- ✅ **Comprehensive coverage**: Tests all key numerical outputs

**What it tests:**
- `compute_pseudo_variance()` vs TraMineR's `dissvar()`: Exact variance values
- `compute_distance_association()` vs TraMineR's `dissassoc()`: Pseudo F, R², p-values
- `build_distance_tree()` vs TraMineR's `disstree()`: Tree structure and leaf counts
- `build_sequence_tree()` vs TraMineR's `seqtree()`: Sequence tree structure

**Prerequisites:**
Before running these tests, generate TraMineR reference files:
```bash
Rscript tests/tree_analysis/traminer_reference.R
```

This creates reference CSV files:
- `ref_dissvar.csv`: Variance values from TraMineR
- `ref_dissassoc.csv`: Association test results from TraMineR
- `ref_disstree_info.csv`: Distance tree structure info
- `ref_disstree_leaves.csv`: Leaf memberships from distance tree
- `ref_seqtree_leaves.csv`: Leaf memberships from sequence tree

**When to use:**
- Before releases: Verify that implementation matches TraMineR exactly
- After code changes: Ensure modifications don't break numerical consistency
- For debugging: Identify discrepancies when results don't match TraMineR
- For validation: Confirm that formulas and algorithms are correctly implemented

## Running Tests

```bash
# Run all tree analysis tests
pytest tests/tree_analysis/ -v

# Run only functional tests (no TraMineR reference files needed)
pytest tests/tree_analysis/test_tree_analysis_lsog.py -v

# Run only consistency tests (requires reference files)
pytest tests/tree_analysis/test_traminer_consistency.py -v

# Run specific test
pytest tests/tree_analysis/test_tree_analysis_lsog.py::test_compute_pseudo_variance_unweighted -v
```

## Quick Start Guide

### For Development (Quick Testing)
```bash
# Run functional tests - no setup needed
pytest tests/tree_analysis/test_tree_analysis_lsog.py -v
```

### For Release Validation (Full Consistency Check)
```bash
# Step 1: Generate TraMineR reference files
Rscript tests/tree_analysis/traminer_reference.R

# Step 2: Run consistency tests
pytest tests/tree_analysis/test_traminer_consistency.py -v

# Step 3: Run all tests
pytest tests/tree_analysis/ -v
```

## Test Coverage

Both test files cover the same functions but with different focuses:

### Functions Tested

1. **`compute_pseudo_variance()`** (TraMineR: `dissvar()`)
   - ✅ Functional tests: Unweighted, weighted, squared distances
   - ✅ Consistency tests: Exact numerical comparison with TraMineR

2. **`compute_distance_association()`** (TraMineR: `dissassoc()`)
   - ✅ Functional tests: Basic association testing, structure validation
   - ✅ Consistency tests: Exact pseudo F, R², p-values comparison
   - ⚠️ Permutation test: Basic structure implemented, full implementation pending

3. **`build_distance_tree()`** (TraMineR: `disstree()`)
   - ✅ Functional tests: Basic tree building, weighted trees, constraints
   - ✅ Consistency tests: Tree structure and leaf count comparison
   - ⚠️ Permutation test: Simplified version, full implementation pending

4. **`build_sequence_tree()`** (TraMineR: `seqtree()`)
   - ✅ Functional tests: Automatic distance computation, weight extraction
   - ✅ Consistency tests: Sequence tree structure comparison

5. **`get_leaf_membership()`** (TraMineR: `disstreeleaf()`)
   - ✅ Functional tests: Leaf ID retrieval, label generation

### ✅ Fully Implemented

- **Permutation tests**: Complete TraMineR-compatible implementation
  - Supports all weight permutation methods: "none", "replicate", "diss", "group"
  - Used in both `compute_distance_association()` and `build_distance_tree()`
  - Matches TraMineR's `DTNdissassocweighted()` and `dissassocweighted.*()` functions
  
- **Classification rules**: Complete Python condition conversion
  - `get_classification_rules()`: Converts tree paths to Python-evaluable expressions
  - `assign_to_leaves()`: Assigns profiles to leaf nodes using classification rules
  - Handles both categorical and continuous variables
  - Supports missing value handling
  
- **Tree visualization**: Complete visualization functions
  - `plot_tree()`: Matplotlib-based tree visualization
  - `print_tree()`: Text-based tree printing
  - `export_tree_to_dot()`: GraphViz DOT format export (requires graphviz package)

## Summary: Which Test File to Use?

| Scenario | Use This File | Why |
|----------|---------------|-----|
| **Daily development** | `test_tree_analysis_lsog.py` | Fast, no setup needed, catches bugs early |
| **CI/CD pipeline** | `test_tree_analysis_lsog.py` | No external dependencies, runs quickly |
| **Before release** | Both files | Functional + numerical consistency validation |
| **Debugging numerical issues** | `test_traminer_consistency.py` | Identifies exact discrepancies with TraMineR |
| **Verifying formulas** | `test_traminer_consistency.py` | Ensures mathematical correctness |
| **No R/TraMineR installed** | `test_tree_analysis_lsog.py` | Works without external dependencies |

## Generating TraMineR Reference Files

The `test_traminer_consistency.py` tests require reference files generated by TraMineR.
To generate these files, run:

```bash
Rscript tests/tree_analysis/traminer_reference.R
```

This R script (`traminer_reference.R`) will:
1. Load the dyadic_children dataset (first 20 rows)
2. Create sequence objects and compute distance matrices
3. Run TraMineR functions: `dissvar()`, `dissassoc()`, `disstree()`, `seqtree()`
4. Save numerical results to CSV files in `tests/tree_analysis/`:
   - `ref_dissvar.csv`: Variance values (unweighted, weighted, squared)
   - `ref_dissassoc.csv`: Association test results (pseudo F, R², p-values)
   - `ref_disstree_info.csv`: Distance tree structure information
   - `ref_disstree_leaves.csv`: Leaf memberships from distance tree
   - `ref_seqtree_leaves.csv`: Leaf memberships from sequence tree

**Note:** The R script uses `set.seed(12345)` for reproducibility, ensuring that
random components (like permutation tests) produce consistent results across runs.

## Implementation Status

### ✅ Fully Implemented Features

1. **Permutation tests**: Complete TraMineR-compatible implementation
   - `permutation.py`: Core permutation test framework matching `TraMineR.permutation()`
   - `dissassoc_permutation.py`: Permutation tests for `dissassoc()` matching `dissassocweighted.*()`
   - Supports all weight permutation methods: "none", "replicate", "diss", "group"
   - Used in both `compute_distance_association()` and `build_distance_tree()`

2. **Classification rules**: Complete Python condition conversion
   - `get_classification_rules()`: Converts tree paths to Python-evaluable expressions
   - `_label_to_python_condition()`: Parses labels and converts to Python syntax
   - `assign_to_leaves()`: Assigns profiles to leaf nodes using classification rules
   - Handles categorical variables: `var in ['val1', 'val2']`
   - Handles continuous variables: `var <= value` or `var > value`
   - Supports missing value handling with `pd.isna()` checks

3. **Tree visualization**: Complete visualization functions
   - `plot_tree()`: Matplotlib-based tree visualization with node information
   - `print_tree()`: Text-based tree printing (similar to TraMineR's print method)
   - `export_tree_to_dot()`: GraphViz DOT format export (requires `graphviz` package)
   - Shows node IDs, split conditions, sample sizes, variances, and R² values

### ⚠️ Known Limitations

1. **Medoid calculation**: Currently using first sequence as placeholder. Should compute actual medoid using distance to center.

2. **Performance**: For large datasets, permutation tests can be slow. Consider using parallel processing for R > 1000.

3. **GraphViz dependency**: `export_tree_to_dot()` requires the `graphviz` Python package and GraphViz system installation.
