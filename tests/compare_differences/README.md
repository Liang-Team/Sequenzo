# Compare Differences Tests

This directory contains tests for the compare_differences module, validating against TraMineR's `seqdiff()` and TraMineRextras's `seqCompare()`, `seqLRT()`, and `seqBIC()` functions.

## Test Dataset

Tests use the **dyadic_children (lsog)** dataset with the first 20 sequences for faster execution.

## Test Files Overview

This directory contains **two complementary test files** with different purposes:

### 1. `test_compare_differences_lsog.py` - Functional Testing

**Purpose:** Validates that functions work correctly and produce reasonable results.

**Characteristics:**
- ✅ **No external dependencies**: Does not require TraMineR reference files
- ✅ **Fast execution**: Tests basic functionality without heavy computations
- ✅ **Development-friendly**: Can run during development to catch bugs early
- ✅ **CI/CD ready**: Suitable for continuous integration pipelines

**What it tests:**
- Function correctness: Functions execute without errors
- Data structure integrity: Return values have correct structure and types
- Logical consistency: Results satisfy expected mathematical properties
  - Pseudo R² is between 0 and 1
  - Pseudo F is non-negative
  - p-values are between 0 and 1
  - Bayes Factor is positive
- Edge cases: Functions handle boundary conditions appropriately
- Different parameter combinations work correctly

**When to use:**
- During development to ensure functions work correctly
- In CI/CD pipelines for quick validation
- When you want to test functionality without setting up R/TraMineR

### 2. `test_traminer_consistency.py` - Numerical Consistency Verification

**Purpose:** Performs precise numerical comparisons with TraMineR/TraMineRextras to ensure identical results.

**Characteristics:**
- ⚠️ **Requires TraMineR reference files**: Needs CSV files generated by `traminer_reference.R`
- ✅ **Strict numerical tolerance**: Uses RTOL=1e-6, ATOL=1e-8 for comparisons
- ✅ **Skips gracefully**: If reference files are missing, tests are skipped (not failed)
- ✅ **Comprehensive coverage**: Tests all key numerical outputs with different parameter combinations

**What it tests:**
- `compare_groups_across_positions()` vs TraMineR's `seqdiff()`:
  - Statistics (Pseudo F, Pseudo R², Bartlett, Levene)
  - Discrepancy values per group
  - Different `cmprange` values: (0,1), (-2,2)
  - Different distance methods: LCS, OM
  - `squared` parameter: True/False
- `compare_groups_overall()` vs TraMineRextras's `seqCompare()`:
  - LRT statistics and p-values
  - BIC statistics and Bayes Factors
  - Different `stat` values: "all", "LRT", "BIC"
  - Different distance methods: LCS, OM
  - Different sample sizes: s=0, s=50, s=100
  - `weighted` parameter: True/False
- `compute_likelihood_ratio_test()` vs TraMineRextras's `seqLRT()`
- `compute_bayesian_information_criterion_test()` vs TraMineRextras's `seqBIC()`

**Prerequisites:**
Before running these tests, generate TraMineR reference files:
```bash
Rscript tests/compare_differences/traminer_reference.R
```

This will create reference CSV files:
- `ref_seqdiff_stat_*.csv`: Statistics from TraMineR seqdiff()
- `ref_seqdiff_discrepancy_*.csv`: Discrepancy values from TraMineR seqdiff()
- `ref_seqCompare_*.csv`: Results from TraMineRextras seqCompare()
- `ref_seqLRT_*.csv`: Results from TraMineRextras seqLRT()
- `ref_seqBIC_*.csv`: Results from TraMineRextras seqBIC()

**When to use:**
- Before releases: Verify that implementation matches TraMineR exactly
- After code changes: Ensure modifications don't break numerical consistency
- For debugging: Identify discrepancies when results don't match TraMineR
- For validation: Confirm that formulas and algorithms are correctly implemented

## Running Tests

### Run functional tests (no R required):
```bash
pytest tests/compare_differences/test_compare_differences_lsog.py -v
```

### Run consistency tests (requires R reference files):
```bash
# First, generate reference files
Rscript tests/compare_differences/traminer_reference.R

# Then run tests
pytest tests/compare_differences/test_traminer_consistency.py -v
```

### Run all tests:
```bash
pytest tests/compare_differences/ -v
```

## Reference File Generation

The `traminer_reference.R` script generates reference results from TraMineR and TraMineRextras for comparison. It tests various parameter combinations:

**seqdiff tests:**
- `cmprange=(0, 1)` with method='LCS'
- `cmprange=(-2, 2)` with method='LCS'
- `cmprange=(0, 1)` with method='OM'
- `squared=TRUE` with method='LCS'

**seqCompare tests:**
- `stat="all"` with method='LCS'
- `stat="LRT"` with method='LCS'
- `stat="BIC"` with method='LCS'
- `stat="all"` with method='OM'
- `s=0` (no sampling)
- `s=50` (smaller sample)
- `weighted=FALSE`

**seqLRT and seqBIC tests:**
- Basic functionality with method='LCS', s=100

## Notes

- Tests use a fixed random seed (36963) for reproducibility, matching TraMineRextras default
- The lsog dataset is limited to 20 sequences for faster test execution
- Numerical tolerance is set to RTOL=1e-6, ATOL=1e-8 to account for floating-point precision differences
- Missing reference files cause tests to be skipped, not failed, allowing CI/CD to run without R setup
