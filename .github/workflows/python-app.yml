# GitHub Actions workflow for Sequenzo package
name: Build Wheels for Sequenzo

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build ${{ matrix.os }} Py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout source with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Ensure setuptools/wheel for macOS Python 3.12
        if: runner.os == 'macOS' && matrix.python-version == '3.12'
        run: python -m pip install --upgrade pip setuptools wheel

      # Add OpenMP support
      - name: Install OpenMP (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libomp
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix libomp)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix libomp)/include" >> $GITHUB_ENV
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $GITHUB_ENV

      - name: Install OpenMP (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libomp-dev
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $GITHUB_ENV

      - name: Setup MSVC with OpenMP (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Enable OpenMP (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $env:GITHUB_ENV

      - name: Install R (Windows, without Rtools)
        if: runner.os == 'Windows'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.1'
          rtools-version: none  # 显式跳过 Rtools 安装，避免 PATH 冲突

      # Install dependencies with fallback strategy
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --only-binary=all "numpy<2.5" || pip install "numpy<2.5"
          pip install --only-binary=all "scipy<1.16" || echo "scipy will be installed in cibuildwheel"
          pip install --prefer-binary Cython pybind11 build "cibuildwheel==2.23.3" twine
          pip install --prefer-binary rpy2 || echo "rpy2 fallback attempted"
          pip install --prefer-binary fastcluster || echo "fastcluster installation attempted"

      - name: Build Cython wheels on macOS
        if: runner.os == 'macOS'
        run: |
          python setup.py build_ext --inplace
          python -m build

      - name: Clean previous build outputs
        if: runner.os != 'macOS'
        run: |
          rm -rf build/ dist/ *.egg-info
          find . -name "*.so" -delete
        shell: bash

      - name: Build wheels with cibuildwheel
        if: runner.os != 'macOS'
        run: python -m cibuildwheel --output-dir dist
        env:
          CIBW_SKIP: "*-musllinux* pp*"  # 跳过 musllinux 和 PyPy
          CIBW_ARCHS_WINDOWS: "AMD64"
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_BUILD_VERBOSITY: "1"

          # Environment variables
          CIBW_ENVIRONMENT_LINUX: SEQUENZO_ENABLE_OPENMP=1 R_HOME=/usr/lib64/R LD_LIBRARY_PATH=/usr/lib64/R/lib
          CIBW_ENVIRONMENT_WINDOWS: SEQUENZO_ENABLE_OPENMP=1 DISTUTILS_USE_SDK=1

          # Linux: install system dependencies (manylinux uses yum)
          CIBW_BEFORE_BUILD_LINUX: |
            yum install -y epel-release
            yum install -y R R-devel
            mkdir -p /usr/lib64/R/bin
            ln -s /usr/bin/R /usr/lib64/R/bin/R
            echo "Creating R symlink for rpy2 build"
            export PATH=/usr/bin:$PATH
            export R_HOME=/usr/lib64/R
            export LD_LIBRARY_PATH=/usr/lib64/R/lib
            echo "R_HOME set to $R_HOME"
            echo "which R: $(which R)"
            python -m pip install --upgrade pip
            python -m pip install --prefer-binary rpy2 || python -m pip install rpy2
            echo "System dependencies installation attempted"

          # Windows: setup MSVC environment and install rpy2
          CIBW_BEFORE_BUILD_WINDOWS: |
            echo "Setting up MSVC environment"
            call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
            set PATH="C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\bin\HostX64\x64";%PATH%
            echo %PATH%
            echo "Using setup.py dependencies only"
            python -m pip install --upgrade pip
            python -m pip install --prefer-binary rpy2

          # Universal dependency installation (fallback)
          CIBW_BEFORE_BUILD: >
            echo "Using setup.py dependencies only"

          # Linux: prepare test environment (install R for rpy2 dependency installation)
          CIBW_BEFORE_TEST_LINUX: |
            yum install -y epel-release
            yum install -y R R-devel
            mkdir -p /usr/lib64/R/bin
            ln -s /usr/bin/R /usr/lib64/R/bin/R
            echo "Creating R symlink for rpy2 test installation"
            export PATH=/usr/bin:$PATH
            export R_HOME=/usr/lib64/R
            export LD_LIBRARY_PATH=/usr/lib64/R/lib
            echo "R_HOME set to $R_HOME for test"
            echo "which R: $(which R)"

          # Test command: use heredoc to keep the entire script in one shell command (fix Linux quoting)
          CIBW_TEST_COMMAND: |
            python - <<'PY'
            import importlib
            import sys
            import numpy as np

            import sequenzo
            print('Sequenzo import successful')

            mod = importlib.util.find_spec('sequenzo.clustering.clustering_c_code')
            print('Clustering C++ extensions loaded' if mod else 'WARNING: Clustering C++ extensions not found')

            try:
                from sequenzo.dissimilarity_measures import c_code
                print('Dissimilarity measures C++ extensions (c_code) loaded successfully')
                
                # Test specific C++ classes
                try:
                    # Test if classes are available (don't instantiate to avoid errors)
                    if hasattr(c_code, 'OMdistance'):
                        print('✓ OMdistance class available')
                    if hasattr(c_code, 'OMspellDistance'):
                        print('✓ OMspellDistance class available')
                    if hasattr(c_code, 'DHDdistance'):
                        print('✓ DHDdistance class available')
                    if hasattr(c_code, 'LCPdistance'):
                        print('✓ LCPdistance class available')
                    if hasattr(c_code, 'dist2matrix'):
                        print('✓ dist2matrix class available')
                except Exception as e:
                    print(f'WARNING: Some C++ classes may not be available: {e}')
                    
            except ImportError as e:
                print(f'ERROR: Dissimilarity measures C++ extensions (c_code) failed to load: {e}')

            cython_modules = [
                'get_sm_trate_substitution_cost_matrix',
                'seqconc', 
                'seqdss',
                'seqdur',
                'seqlength'
            ]
            
            for module_name in cython_modules:
                try:
                    module = __import__(f'sequenzo.dissimilarity_measures.utils.{module_name}', fromlist=[module_name])
                    print(f'✓ Cython module {module_name} loaded successfully')
                except ImportError as e:
                    print(f'ERROR: Cython module {module_name} failed to load: {e}')

            try:
                from sequenzo.dissimilarity_measures.utils import (
                    get_sm_trate_substitution_cost_matrix, seqconc, seqdss, seqdur, seqlength
                )
                print('✓ All utility functions imported successfully')
            except ImportError as e:
                print(f'ERROR: Utility functions failed to load: {e}')

            try:
                import rpy2.robjects as ro
                from rpy2.robjects.packages import importr
                print('R environment (rpy2) loaded successfully')
                try:
                    fastcluster_r = importr('fastcluster')
                    print('R fastcluster package available')
                except Exception as e:
                    print(f'WARNING: R fastcluster package not available: {e}')
            except ImportError as e:
                print(f'WARNING: R environment (rpy2) not available: {e}')
            PY

          # Windows test command using python -c with exec for multiline code
          CIBW_TEST_COMMAND_WINDOWS: |
            echo "Testing Sequenzo wheel on Windows"
            echo "" > test_sequenzo_ci.py
            Add-Content test_sequenzo_ci.py @"
            import importlib, sys
            import numpy as np
            import sequenzo
            print('Sequenzo import successful')
          
            mod = importlib.util.find_spec('sequenzo.clustering.clustering_c_code')
            print('Clustering C++ extensions loaded' if mod else 'WARNING: Clustering C++ extensions not found')
          
            try:
                from sequenzo.dissimilarity_measures import c_code
                print('✓ Dissimilarity measures C++ extensions (c_code) loaded successfully')
                for name in ['OMdistance', 'OMspellDistance', 'DHDdistance', 'LCPdistance', 'dist2matrix']:
                    if hasattr(c_code, name):
                        print(f'✓ {name} class available')
            except ImportError as e:
                print(f'ERROR: Failed to import c_code: {e}')
          
            try:
                import rpy2.robjects as ro
                from rpy2.robjects.packages import importr
                print('R environment (rpy2) loaded successfully')
                try:
                    importr('fastcluster')
                    print('R fastcluster package available')
                except Exception as e:
                    print(f'WARNING: R fastcluster package not available: {e}')
            except ImportError as e:
                print(f'WARNING: R environment (rpy2) not available: {e}')
            "@
            python test_sequenzo_ci.py

      - name: Show dist content
        run: ls -lah dist/
        shell: bash

      - name: Check wheels
        run: twine check dist/*

      - name: Verify OpenMP Support
        run: |
          echo "=== Verifying built wheels ==="
          python -c "
          import subprocess
          import sys
          import os
          
          wheel_files = [f for f in os.listdir('dist') if f.endswith('.whl') and 'cp${{ matrix.python-version }}' in f.replace('.', '')]
          if wheel_files:
              wheel_file = wheel_files[0]
              print(f'Installing wheel: {wheel_file}')
              subprocess.run([sys.executable, '-m', 'pip', 'install', '--force-reinstall', f'dist/{wheel_file}'], check=True)
              
              import sequenzo
              print('Sequenzo import successful')
              
              try:
                  import sequenzo.clustering.clustering_c_code as cc
                  print('C++ extensions loaded successfully')
              except ImportError as e:
                  print(f'WARNING: C++ extensions loading failed: {e}')
          else:
              print('ERROR: No matching wheel files found')
          " || echo "Verification completed with warnings"
        shell: bash

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: dist/